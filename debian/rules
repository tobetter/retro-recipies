#!/usr/bin/make -f

# Fix hardening-no-bindnow
# Dolphin needs to be build without pie, https://forums.dolphin-emu.org/Thread-jit-recompiler-not-working?pid=433420#pid433420
export DEB_BUILD_MAINT_OPTIONS = hardening=+bindnow,-pie optimize=-lto

export DEB_LDFLAGS_MAINT_APPEND=-Wl,--as-needed

# distributor is used by the opt-in analytics
ifeq ($(shell dpkg-vendor --derives-from Ubuntu; echo $$?),0)
	DISTRIBUTOR := ubuntu.com
else
	DISTRIBUTOR := debian.org
endif

export DEB_CXXFLAGS_MAINT_STRIP=-O2
export DEB_CFLAGS_MAINT_STRIP=-O2
export DEB_CXXFLAGS_MAINT_PREPEND=-O3
export DEB_CFLAGS_MAINT_PREPEND=-O3

GIT_HASH := $(shell dpkg-parsechangelog | sed -rne 's,^Version: (.*),\1, p' | sed s/-/\\n/g | tail -n 2 | head -n 1)

%:
	dh $@ --buildsystem=cmake --parallel

CMAKE_OPTIONS =                                   \
	-DDOLPHIN_WC_REVISION=$(GIT_HASH)             \
	-DDOLPHIN_WC_DESCRIBE="5.0-$(GIT_HASH)-dirty" \
	-DDOLPHIN_WC_BRANCH="master"                  \
	-DDISTRIBUTOR=$(DISTRIBUTOR)                  \
	-Dbindir=/usr/games                           \
	-Ddatadir=/usr/share/games/dolphin-emu        \
	-DUSE_SHARED_ENET=ON                          \
	-DENABLE_LLVM=0

ARCH=$(shell dpkg-architecture -qDEB_HOST_ARCH)

ifeq ($(ARCH),arm64)
	CMAKE_OPTIONS+=-DENABLE_EGL=ON
endif

CPPFLAGS+=-DNDEBUG

override_dh_auto_configure:
	dh_auto_configure -- $(CMAKE_OPTIONS)

override_dh_auto_test:
ifeq (,$(filter nocheck,$(DEB_BUILD_OPTIONS)))
	CTEST_OUTPUT_ON_FAILURE=1 $(MAKE) -C obj-$(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE) unittests
endif

override_dh_strip:
	dh_strip -pdolphin-emu-libretro --dbg-package=dolphin-emu-libretro-dbg
